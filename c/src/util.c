
#include <stdint.h>

#include "util.h"

/**
 * Multiply a sparse binary matrix with a normal binary array
 * @param {array} sparseMatrix an array of integer indices to the 1's of the
 * sparse row vector
 * @param {array} arr column vector 
 */
void multiplySparse(uint8_t *out, int **sparseMatrix,  int len,  uint8_t *arr) {
	uint8_t *p = out;
	for (int i = 0; i < len; i++) {
		int *row = sparseMatrix[i];
		int sum = 0;
		int rlen = row[0];
		for (int j = 1 ; j <= rlen ; j++) {
			sum ^= arr[row[j]];
		}
		*p++ = sum;
	}
}

/**
 * Perform back substitution sparse binary array with a normal binary array.
 * Assume sparse is lower diagonal
 * y[i] = T[i,1]y[1] + T[i,2]y[2] + · · · + T[i,i−1]y[i−1] + x[i]
 * @param {array} sparseArr an array of integer indices to the 1's of the
 * sparse row vector
 * @param {array} arr column vector 
 */
void substituteSparse(uint8_t *out, int **sparseMatrix, int len, uint8_t *arr) {
	uint8_t *y = out;
	/**
	 * Note that although this looks very similar to the multiplication above,
	 * each iteration depends upon the results of the previous iteration
	 */
	y[0] = arr[0];
	for (int i = 1; i < len; i++) {
		int *row = sparseMatrix[i];
		int sum = 0;
		int rlen = row[0];
		for (int j = 1; j <= rlen ; j++) {
			sum ^= y[row[j]];
		}
		y[i] = sum ^ arr[i];
	}
}

/**
 * Convert an array of bytes to an array of bits. Bigendian.
 * The output array is 8x the size of the input, each element a 1 or 0
 * @param {uint8_t *} bits output buffer for bits
 * @param {uint8_t *} bytes inpuyt array of bytes
 * @param {int} len number of bytes
 */
void bytesToBitsBE(uint8_t *bits, uint8_t *bytes, int len) {
	while (len--) {
		uint8_t b = *bytes++;
		*bits++ = ((b >> 7) & 1);
		*bits++ = ((b >> 6) & 1);
		*bits++ = ((b >> 5) & 1);
		*bits++ = ((b >> 4) & 1);
		*bits++ = ((b >> 3) & 1);
		*bits++ = ((b >> 2) & 1);
		*bits++ = ((b >> 1) & 1);
		*bits++ = ((b) & 1);
	}
}

/** 
 * Assumes bits length is multiple of 8
 * @param {uint8_t *} output buffer for bytes
 * @param {uint8_t *} bits array of bits
 * @param {int} len number of bits
 */
void bitsToBytesBE(uint8_t *bytes, uint8_t *bits, int len) {
	uint8_t b = 0;
	int column = 0;
	while (len--) {
		b = (b << 1) + (*bits++);
		if (++column >= 8) {
			*bytes++ = b;
			b = 0;
			column = 0;
		}
	}
	if (column) {
		*bytes = b;
	}
}





static double phiTable[] = {
	5.6787, 4.9856, 4.5801, 4.2925, 4.0694, 3.8871, 3.7330, 3.5995, 3.4818, 3.3765, 3.2813, 3.1944, 3.1144, 3.0404, 2.9715, 2.9071,
	2.8466, 2.7896, 2.7357, 2.6845, 2.6359, 2.5895, 2.5453, 2.5029, 2.4623, 2.4232, 2.3857, 2.3496, 2.3147, 2.2810, 2.2485, 2.2169,
	2.1864, 2.1568, 2.1281, 2.1002, 2.0731, 2.0467, 2.0210, 1.9960, 1.9717, 1.9479, 1.9247, 1.9020, 1.8799, 1.8583, 1.8371, 1.8164,
	1.7962, 1.7764, 1.7569, 1.7379, 1.7193, 1.7010, 1.6831, 1.6655, 1.6482, 1.6312, 1.6146, 1.5982, 1.5822, 1.5664, 1.5509, 1.5356,
	1.5206, 1.5058, 1.4913, 1.4770, 1.4629, 1.4490, 1.4354, 1.4219, 1.4087, 1.3957, 1.3828, 1.3701, 1.3576, 1.3453, 1.3332, 1.3212,
	1.3094, 1.2977, 1.2862, 1.2749, 1.2637, 1.2526, 1.2417, 1.2309, 1.2203, 1.2098, 1.1994, 1.1891, 1.1790, 1.1690, 1.1591, 1.1494,
	1.1397, 1.1302, 1.1208, 1.1115, 1.1022, 1.0931, 1.0841, 1.0752, 1.0664, 1.0577, 1.0491, 1.0406, 1.0322, 1.0239, 1.0156, 1.0075,
	0.9994, 0.9914, 0.9835, 0.9757, 0.9679, 0.9603, 0.9527, 0.9452, 0.9378, 0.9304, 0.9231, 0.9159, 0.9088, 0.9017, 0.8947, 0.8878,
	0.8809, 0.8741, 0.8674, 0.8607, 0.8541, 0.8476, 0.8411, 0.8347, 0.8283, 0.8220, 0.8157, 0.8096, 0.8034, 0.7974, 0.7913, 0.7854,
	0.7795, 0.7736, 0.7678, 0.7620, 0.7563, 0.7507, 0.7451, 0.7395, 0.7340, 0.7286, 0.7232, 0.7178, 0.7125, 0.7072, 0.7020, 0.6968,
	0.6917, 0.6866, 0.6815, 0.6765, 0.6716, 0.6666, 0.6618, 0.6569, 0.6521, 0.6473, 0.6426, 0.6379, 0.6333, 0.6287, 0.6241, 0.6196,
	0.6151, 0.6106, 0.6062, 0.6018, 0.5975, 0.5932, 0.5889, 0.5847, 0.5804, 0.5763, 0.5721, 0.5680, 0.5639, 0.5599, 0.5559, 0.5519,
	0.5479, 0.5440, 0.5401, 0.5363, 0.5324, 0.5286, 0.5249, 0.5211, 0.5174, 0.5137, 0.5101, 0.5065, 0.5029, 0.4993, 0.4957, 0.4922,
	0.4887, 0.4853, 0.4818, 0.4784, 0.4750, 0.4717, 0.4684, 0.4650, 0.4618, 0.4585, 0.4553, 0.4521, 0.4489, 0.4457, 0.4426, 0.4395,
	0.4364, 0.4333, 0.4303, 0.4272, 0.4242, 0.4213, 0.4183, 0.4154, 0.4125, 0.4096, 0.4067, 0.4039, 0.4010, 0.3982, 0.3955, 0.3927,
	0.3899, 0.3872, 0.3845, 0.3818, 0.3792, 0.3765, 0.3739, 0.3713, 0.3687, 0.3661, 0.3636, 0.3611, 0.3585, 0.3560, 0.3536, 0.3511,
	0.3487, 0.3462, 0.3438, 0.3415, 0.3391, 0.3367, 0.3344, 0.3321, 0.3298, 0.3275, 0.3252, 0.3230, 0.3207, 0.3185, 0.3163, 0.3141,
	0.3119, 0.3098, 0.3076, 0.3055, 0.3034, 0.3013, 0.2992, 0.2971, 0.2951, 0.2930, 0.2910, 0.2890, 0.2870, 0.2850, 0.2831, 0.2811,
	0.2792, 0.2772, 0.2753, 0.2734, 0.2715, 0.2697, 0.2678, 0.2660, 0.2641, 0.2623, 0.2605, 0.2587, 0.2569, 0.2552, 0.2534, 0.2516,
	0.2499, 0.2482, 0.2465, 0.2448, 0.2431, 0.2414, 0.2398, 0.2381, 0.2365, 0.2349, 0.2332, 0.2316, 0.2301, 0.2285, 0.2269, 0.2253,
	0.2238, 0.2223, 0.2207, 0.2192, 0.2177, 0.2162, 0.2147, 0.2133, 0.2118, 0.2103, 0.2089, 0.2075, 0.2060, 0.2046, 0.2032, 0.2018,
	0.2004, 0.1991, 0.1977, 0.1963, 0.1950, 0.1937, 0.1923, 0.1910, 0.1897, 0.1884, 0.1871, 0.1858, 0.1846, 0.1833, 0.1820, 0.1808,
	0.1796, 0.1783, 0.1771, 0.1759, 0.1747, 0.1735, 0.1723, 0.1711, 0.1700, 0.1688, 0.1676, 0.1665, 0.1653, 0.1642, 0.1631, 0.1620,
	0.1609, 0.1598, 0.1587, 0.1576, 0.1565, 0.1554, 0.1544, 0.1533, 0.1523, 0.1512, 0.1502, 0.1492, 0.1482, 0.1471, 0.1461, 0.1451,
	0.1441, 0.1432, 0.1422, 0.1412, 0.1402, 0.1393, 0.1383, 0.1374, 0.1364, 0.1355, 0.1346, 0.1337, 0.1328, 0.1318, 0.1309, 0.1301,
	0.1292, 0.1283, 0.1274, 0.1265, 0.1257, 0.1248, 0.1240, 0.1231, 0.1223, 0.1214, 0.1206, 0.1198, 0.1190, 0.1182, 0.1173, 0.1165,
	0.1157, 0.1150, 0.1142, 0.1134, 0.1126, 0.1119, 0.1111, 0.1103, 0.1096, 0.1088, 0.1081, 0.1073, 0.1066, 0.1059, 0.1052, 0.1044,
	0.1037, 0.1030, 0.1023, 0.1016, 0.1009, 0.1002, 0.0996, 0.0989, 0.0982, 0.0975, 0.0969, 0.0962, 0.0956, 0.0949, 0.0943, 0.0936,
	0.0930, 0.0923, 0.0917, 0.0911, 0.0905, 0.0898, 0.0892, 0.0886, 0.0880, 0.0874, 0.0868, 0.0862, 0.0856, 0.0851, 0.0845, 0.0839,
	0.0833, 0.0828, 0.0822, 0.0816, 0.0811, 0.0805, 0.0800, 0.0794, 0.0789, 0.0783, 0.0778, 0.0773, 0.0768, 0.0762, 0.0757, 0.0752,
	0.0747, 0.0742, 0.0737, 0.0732, 0.0727, 0.0722, 0.0717, 0.0712, 0.0707, 0.0702, 0.0697, 0.0693, 0.0688, 0.0683, 0.0679, 0.0674,
	0.0669, 0.0665, 0.0660, 0.0656, 0.0651, 0.0647, 0.0642, 0.0638, 0.0634, 0.0629, 0.0625, 0.0621, 0.0617, 0.0612, 0.0608, 0.0604,
	0.0600, 0.0596, 0.0592, 0.0588, 0.0584, 0.0580, 0.0576, 0.0572, 0.0568, 0.0564, 0.0560, 0.0557, 0.0553, 0.0549, 0.0545, 0.0542,
	0.0538, 0.0534, 0.0531, 0.0527, 0.0523, 0.0520, 0.0516, 0.0513, 0.0509, 0.0506, 0.0502, 0.0499, 0.0495, 0.0492, 0.0489, 0.0485,
	0.0482, 0.0479, 0.0476, 0.0472, 0.0469, 0.0466, 0.0463, 0.0460, 0.0456, 0.0453, 0.0450, 0.0447, 0.0444, 0.0441, 0.0438, 0.0435,
	0.0432, 0.0429, 0.0426, 0.0423, 0.0420, 0.0418, 0.0415, 0.0412, 0.0409, 0.0406, 0.0404, 0.0401, 0.0398, 0.0395, 0.0393, 0.0390,
	0.0387, 0.0385, 0.0382, 0.0379, 0.0377, 0.0374, 0.0372, 0.0369, 0.0367, 0.0364, 0.0362, 0.0359, 0.0357, 0.0354, 0.0352, 0.0350,
	0.0347, 0.0345, 0.0342, 0.0340, 0.0338, 0.0336, 0.0333, 0.0331, 0.0329, 0.0326, 0.0324, 0.0322, 0.0320, 0.0318, 0.0315, 0.0313,
	0.0311, 0.0309, 0.0307, 0.0305, 0.0303, 0.0301, 0.0299, 0.0297, 0.0295, 0.0293, 0.0291, 0.0289, 0.0287, 0.0285, 0.0283, 0.0281,
	0.0279, 0.0277, 0.0275, 0.0273, 0.0271, 0.0270, 0.0268, 0.0266, 0.0264, 0.0262, 0.0261, 0.0259, 0.0257, 0.0255, 0.0254, 0.0252,
	0.0250, 0.0248, 0.0247, 0.0245, 0.0243, 0.0242, 0.0240, 0.0238, 0.0237, 0.0235, 0.0234, 0.0232, 0.0230, 0.0229, 0.0227, 0.0226,
	0.0224, 0.0223, 0.0221, 0.0220, 0.0218, 0.0217, 0.0215, 0.0214, 0.0212, 0.0211, 0.0209, 0.0208, 0.0206, 0.0205, 0.0204, 0.0202,
	0.0201, 0.0200, 0.0198, 0.0197, 0.0196, 0.0194, 0.0193, 0.0192, 0.0190, 0.0189, 0.0188, 0.0186, 0.0185, 0.0184, 0.0183, 0.0181,
	0.0180, 0.0179, 0.0178, 0.0176, 0.0175, 0.0174, 0.0173, 0.0172, 0.0171, 0.0169, 0.0168, 0.0167, 0.0166, 0.0165, 0.0164, 0.0163,
	0.0161, 0.0160, 0.0159, 0.0158, 0.0157, 0.0156, 0.0155, 0.0154, 0.0153, 0.0152, 0.0151, 0.0150, 0.0149, 0.0148, 0.0147, 0.0146,
	0.0145, 0.0144, 0.0143, 0.0142, 0.0141, 0.0140, 0.0139, 0.0138, 0.0137, 0.0136, 0.0135, 0.0134, 0.0133, 0.0132, 0.0132, 0.0131,
	0.0130, 0.0129, 0.0128, 0.0127, 0.0126, 0.0125, 0.0125, 0.0124, 0.0123, 0.0122, 0.0121, 0.0120, 0.0120, 0.0119, 0.0118, 0.0117,
	0.0116, 0.0115, 0.0115, 0.0114, 0.0113, 0.0112, 0.0112, 0.0111, 0.0110, 0.0109, 0.0109, 0.0108, 0.0107, 0.0106, 0.0106, 0.0105,
	0.0104, 0.0104, 0.0103, 0.0102, 0.0101, 0.0101, 0.0100, 0.0099, 0.0099, 0.0098, 0.0097, 0.0097, 0.0096, 0.0095, 0.0095, 0.0094,
	0.0093, 0.0093, 0.0092, 0.0092, 0.0091, 0.0090, 0.0090, 0.0089, 0.0088, 0.0088, 0.0087, 0.0087, 0.0086, 0.0085, 0.0085, 0.0084,
	0.0084, 0.0083, 0.0083, 0.0082, 0.0081, 0.0081, 0.0080, 0.0080, 0.0079, 0.0079, 0.0078, 0.0078, 0.0077, 0.0077, 0.0076, 0.0076,
	0.0075, 0.0075, 0.0074, 0.0074, 0.0073, 0.0073, 0.0072, 0.0072, 0.0071, 0.0071, 0.0070, 0.0070, 0.0069, 0.0069, 0.0068, 0.0068,
	0.0067, 0.0067, 0.0066, 0.0066, 0.0065, 0.0065, 0.0065, 0.0064, 0.0064, 0.0063, 0.0063, 0.0062, 0.0062, 0.0062, 0.0061, 0.0061,
	0.0060, 0.0060, 0.0060, 0.0059, 0.0059, 0.0058, 0.0058, 0.0058, 0.0057, 0.0057, 0.0056, 0.0056, 0.0056, 0.0055, 0.0055, 0.0054,
	0.0054, 0.0054, 0.0053, 0.0053, 0.0053, 0.0052, 0.0052, 0.0052, 0.0051, 0.0051, 0.0051, 0.0050, 0.0050, 0.0049, 0.0049, 0.0049,
	0.0048, 0.0048, 0.0048, 0.0047, 0.0047, 0.0047, 0.0047, 0.0046, 0.0046, 0.0046, 0.0045, 0.0045, 0.0045, 0.0044, 0.0044, 0.0044,
	0.0043, 0.0043, 0.0043, 0.0043, 0.0042, 0.0042, 0.0042, 0.0041, 0.0041, 0.0041, 0.0041, 0.0040, 0.0040, 0.0040, 0.0039, 0.0039,
	0.0039, 0.0039, 0.0038, 0.0038, 0.0038, 0.0038, 0.0037, 0.0037, 0.0037, 0.0037, 0.0036, 0.0036, 0.0036, 0.0036, 0.0035, 0.0035,
	0.0035, 0.0035, 0.0034, 0.0034, 0.0034, 0.0034, 0.0034, 0.0033, 0.0033, 0.0033, 0.0033, 0.0032, 0.0032, 0.0032, 0.0032, 0.0032,
	0.0031, 0.0031, 0.0031, 0.0031, 0.0030, 0.0030, 0.0030, 0.0030, 0.0030, 0.0029, 0.0029, 0.0029, 0.0029, 0.0029, 0.0028, 0.0028,
	0.0028, 0.0028, 0.0028, 0.0027, 0.0027, 0.0027, 0.0027, 0.0027, 0.0027, 0.0026, 0.0026, 0.0026, 0.0026, 0.0026, 0.0025, 0.0025,
	0.0025, 0.0025, 0.0025, 0.0025, 0.0024, 0.0024, 0.0024, 0.0024, 0.0024, 0.0024, 0.0023, 0.0023, 0.0023, 0.0023, 0.0023, 0.0023,
	0.0023, 0.0022, 0.0022, 0.0022, 0.0022, 0.0022, 0.0022, 0.0021, 0.0021, 0.0021, 0.0021, 0.0021, 0.0021, 0.0021, 0.0020, 0.0020,
	0.0020, 0.0020, 0.0020, 0.0020, 0.0020, 0.0020, 0.0019, 0.0019, 0.0019, 0.0019, 0.0019, 0.0019, 0.0019, 0.0018, 0.0018, 0.0018
 };


/**
 * Calculate the "phi" function over the range 0-7
 * @param x the input value
 * @return estimated phi value for x
 */
double calcPhi(double x) {
	if (x >= 7.0) {
		return 0.0;
	}
	int idx = (int)(x * 146.28571);
	return phiTable[idx];
}




